<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>回测报告</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .chart-container { width: 100%; height: 400px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.1); margin-top: 20px; }
        .kpi-card { text-align: center; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; }
        .kpi-label { font-size: 0.9rem; color: #6c757d; }
        .positive { color: #198754; }
        .negative { color: #dc3545; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4">回测报告</h1>

    <!-- 前端调试信息 -->
    <div th:if="${klineDates != null}" class="alert alert-info">
        <strong>调试信息:</strong>
        K线数据点: <span th:text="${#lists.size(klineDates)}"></span> | 
        买点: <span th:text="${#lists.size(buyPoints)}"></span> | 
        卖点: <span th:text="${#lists.size(sellPoints)}"></span>
    </div>

    <!-- 报告元数据 -->
    <div class="card mb-4">
        <div class="card-header">报告详情</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4"><strong>策略名称:</strong> <span th:text="${report.strategyName}"></span></div>
                <div class="col-md-4"><strong>股票代码:</strong> <span th:text="${report.symbol}"></span></div>
                <div class="col-md-4"><strong>报告ID:</strong> <small class="text-muted" th:text="${report.id}"></small></div>
            </div>
            <div class="row mt-2">
                <div class="col-md-4"><strong>回测周期:</strong> <span th:text="${report.startDate} + ' to ' + ${report.endDate}"></span></div>
                <div class="col-md-4"><strong>报告生成时间:</strong> <span th:text="${#temporals.format(report.backtestRunTime, 'yyyy-MM-dd HH:mm:ss')}"></span></div>
            </div>
        </div>
    </div>

    <!-- 关键指标汇总 -->
    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:classappend="${report.annualizedReturn > 0 ? 'positive' : 'negative'}" th:text="${#numbers.formatPercent(report.annualizedReturn, 1, 2)}"></div>
                    <div class="kpi-label">年化收益率</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value negative" th:text="${#numbers.formatPercent(report.maxDrawdown, 1, 2)}"></div>
                    <div class="kpi-label">最大回撤</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:classappend="${report.sharpeRatio > 0 ? 'positive' : 'negative'}" th:text="${#numbers.formatDecimal(report.sharpeRatio, 1, 2)}"></div>
                    <div class="kpi-label">夏普比率</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:classappend="${report.winRate > 0.5 ? 'positive' : 'negative'}" th:text="${#numbers.formatPercent(report.winRate, 1, 2)}"></div>
                    <div class="kpi-label">胜率</div>
                </div>
            </div>
        </div>
    </div>
    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:text="${report.totalTrades}"></div>
                    <div class="kpi-label">总交易次数</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:classappend="${report.profitLossRatio > 1 ? 'positive' : 'negative'}" th:text="${#numbers.formatDecimal(report.profitLossRatio, 1, 2)}"></div>
                    <div class="kpi-label">盈亏比</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:text="${#numbers.formatDecimal(report.initialCapital, 1, 0, 'COMMA')}"></div>
                    <div class="kpi-label">初始资金</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="kpi-value" th:classappend="${report.finalCapital > report.initialCapital ? 'positive' : 'negative'}" th:text="${#numbers.formatDecimal(report.finalCapital, 1, 0, 'COMMA')}"></div>
                    <div class="kpi-label">最终权益</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 权益曲线图 -->
    <div class="card mb-4">
        <div class="card-header">权益曲线 (Equity Curve)</div>
        <div class="card-body">
            <div id="equityCurveChart" class="chart-container"></div>
        </div>
    </div>

    <!-- K线与买卖点 -->
    <div class="card mb-4">
        <div class="card-header">价格与买卖点</div>
        <div class="card-body">
            <div id="candlestickChart" class="chart-container"></div>
        </div>
    </div>

    <!-- 交易记录详情 -->
    <div class="card mb-4">
        <div class="card-header">交易记录</div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>方向</th>
                        <th>价格</th>
                        <th>数量</th>
                        <th>盈亏</th>
                        <th>原因</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${tradeHistory}">
                        <td th:text="${#temporals.format(order.createTime, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <span th:text="${order.side.name()}" 
                                  th:classappend="${order.side.name() == 'BUY' ? 'text-danger' : 'text-success'}" 
                                  class="fw-bold"></span>
                        </td>
                        <td th:text="${order.executedPrice != null ? #numbers.formatDecimal(order.executedPrice, 1, 2) : #numbers.formatDecimal(order.price, 1, 2)}"></td>
                        <td th:text="${order.quantity}"></td>
                        <td>
                            <span th:if="${order.realizedPnl != null}" 
                                  th:text="${#numbers.formatDecimal(order.realizedPnl, 1, 2)}" 
                                  th:classappend="${order.realizedPnl.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? 'text-success' : 'text-danger'}"></span>
                        </td>
                        <td th:text="${order.rationale}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- TODO: 其他图表容器 -->

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/

    // 1. 权益曲线图
    var equityCurveChart = echarts.init(document.getElementById('equityCurveChart'));
    var equityDates = /*[[${equityDates}]]*/ [];
    var equityValues = /*[[${equityValues}]]*/ [];

    var equityOption = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
        },
        xAxis: {
            type: 'category',
            data: equityDates
        },
        yAxis: {
            type: 'value',
            scale: true,
            axisLabel: { formatter: '{value}' }
        },
        series: [{
            name: '总权益',
            type: 'line',
            data: equityValues,
            smooth: true,
            showSymbol: false,
            lineStyle: { color: '#0d6efd' }
        }]
    };
    equityCurveChart.setOption(equityOption);

    // 2. K线与买卖点图
    var candlestickChart = echarts.init(document.getElementById('candlestickChart'));
    var klineDates = /*[[${klineDates}]]*/ [];
    var ohlcValues = /*[[${ohlcValues}]]*/ [];
    var buyPoints = /*[[${buyPoints}]]*/ [];
    var sellPoints = /*[[${sellPoints}]]*/ [];

    if (klineDates && klineDates.length > 0) {
        var candlestickOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' }
            },
            legend: {
                data: ['K线', '买入', '卖出']
            },
            grid: {
                left: '10%',
                right: '10%',
                bottom: '15%'
            },
            xAxis: {
                type: 'category',
                data: klineDates,
                scale: true
            },
            yAxis: {
                type: 'value',
                scale: true,
                splitArea: { show: true }
            },
            dataZoom: [
                { type: 'inside', start: 50, end: 100 },
                { show: true, type: 'slider', top: '90%', start: 50, end: 100 }
            ],
            series: [
                {
                    name: 'K线',
                    type: 'candlestick',
                    data: ohlcValues,
                    itemStyle: {
                        color: '#ef232a',
                        color0: '#14b143',
                        borderColor: '#ef232a',
                        borderColor0: '#14b143'
                    }
                },
                {
                    name: '买入',
                    type: 'scatter',
                    symbol: 'arrow',
                    symbolSize: 15,
                    symbolRotate: 180,
                    itemStyle: { color: '#dc3545' },
                    data: buyPoints.map(p => ({ name: '买入', value: p, itemStyle: { color: '#dc3545' } }))
                },
                {
                    name: '卖出',
                    type: 'scatter',
                    symbol: 'arrow',
                    symbolSize: 15,
                    itemStyle: { color: '#198754' },
                    data: sellPoints.map(p => ({ name: '卖出', value: p, itemStyle: { color: '#198754' } }))
                }
            ]
        };
        candlestickChart.setOption(candlestickOption);
    } else {
        document.getElementById('candlestickChart').innerHTML = '<div class="alert alert-warning">无K线数据可供显示。</div>';
    }

    // 窗口大小改变时重绘图表
    window.addEventListener('resize', function() {
        equityCurveChart.resize();
        if (candlestickChart) candlestickChart.resize();
    });

    /*]]>*/
</script>
</body>
</html>
